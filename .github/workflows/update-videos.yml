name: Update F1 Videos

on:
  schedule:
    # Run every 30 minutes during GP weekends ‚Äî full UTC coverage for Fri/Sat/Sun to avoid delays on APAC rounds
    - cron: '*/30 * * * 5'   # Friday (all day UTC)
    - cron: '*/30 * * * 6'   # Saturday
    - cron: '*/30 * * * 0'   # Sunday
    # Monday morning sweep for late uploads and corrections (00:00‚Äì12:00 UTC)
    - cron: '*/30 0-12 * * 1'
  workflow_dispatch: # Allow manual trigger
    inputs:
      reason:
        description: 'Reason for manual update'
        required: false
        default: 'Manual update requested'
        type: string
      force_update:
        description: 'Force update even if no new videos found'
        required: false
        default: false
        type: boolean
  push:
    branches: [ main ]

jobs:
  update-videos:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow writing to repository
      actions: read    # Allow reading workflow info
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Decide if update is needed
      id: gate
      env:
        MANUAL_RUN: ${{ github.event_name == 'workflow_dispatch' }}
        FORCE_RUN: ${{ github.event.inputs.force_update || 'false' }}
      run: node scripts/should-run.js
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
      if: steps.gate.outputs.run == 'true'
        
    - name: Install dependencies
      run: npm ci
      if: steps.gate.outputs.run == 'true'
      
    - name: Fetch latest videos and standings
      env:
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        MANUAL_RUN: ${{ github.event_name == 'workflow_dispatch' }}
        UPDATE_REASON: ${{ github.event.inputs.reason || 'Scheduled update' }}
        TARGET_YEAR: '2026'
      run: |
        echo "üöÄ Starting F1 data fetch..."
        echo "Reason: $UPDATE_REASON"
        npm run fetch
        npm run fetch-standings
      if: steps.gate.outputs.run == 'true'
      
    - name: Commit and push changes
      run: |
        # Configure git with GitHub Actions bot
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Add generated data to served location (videos + standings)
        git add public/data/videos.json public/data/videos-*.json public/data/standings2026.json
        
        # Check if there are changes or if force update is enabled
        if git diff --staged --quiet && [ "${{ github.event.inputs.force_update }}" != "true" ]; then
          echo "‚úÖ No changes to commit"
        else
          # Create appropriate commit message
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            COMMIT_MSG="üèéÔ∏è Manual F1 video update - ${{ github.event.inputs.reason || 'Manual update' }} ($(date))"
          else
            COMMIT_MSG="üîÑ Auto F1 video update - $(date)"
          fi
          
          echo "üìù Committing with message: $COMMIT_MSG"
          git commit -m "$COMMIT_MSG"

          echo "üîÑ Syncing with latest ${{ github.ref_name }} before push..."
          git fetch origin "${{ github.ref_name }}"
          GIT_EDITOR=: git pull --rebase origin "${{ github.ref_name }}"
          
          echo "üöÄ Pushing changes..."
          git push origin HEAD:${{ github.ref_name }}
          echo "‚úÖ Changes committed and pushed successfully"
        fi
      if: steps.gate.outputs.run == 'true'
      
    - name: Summary
      run: |
        echo "üìä F1 Video Update Summary"
        echo "=========================="
        
        echo "Gate run? ${{ steps.gate.outputs.run || 'false' }} (reason: ${{ steps.gate.outputs.reason || 'n/a' }})"
        
        if [ -f public/data/videos.json ]; then
          TOTAL_VIDEOS=$(node -e "const data = require('./public/data/videos.json'); console.log(data.totalVideos || 0);")
          WEEKENDS=$(node -e "const data = require('./public/data/videos.json'); console.log((data.grandPrixWeekends || []).length);")
          LAST_UPDATED=$(node -e "const data = require('./public/data/videos.json'); console.log(data.lastUpdated || 'Unknown');")
          
          echo "üìπ Total videos: $TOTAL_VIDEOS"
          echo "üèÅ Grand Prix weekends: $WEEKENDS"
          echo "üïí Last updated: $LAST_UPDATED"
          
          if [ "$WEEKENDS" -gt 0 ]; then
            echo ""
            echo "üèéÔ∏è Current weekends:"
            node -e "
              const data = require('./public/data/videos.json');
              (data.grandPrixWeekends || []).forEach((gp, i) => {
                const status = i === 0 ? 'üî¥ Current' : i === 1 ? 'üü° Recent' : '‚ö™ Past';
                console.log(\`  \${status} \${gp.name} (\${gp.videos.length} videos)\`);
              });
            "
          fi
        else
          echo "‚ùå No public/data/videos.json file found"
        fi

        if [ -f public/data/standings2026.json ]; then
          STANDINGS_UPDATED=$(node -e "const data = require('./public/data/standings2026.json'); console.log(data.updatedAt || 'Unknown');")
          SEASON_STARTED=$(node -e "const data = require('./public/data/standings2026.json'); console.log(Boolean(data.seasonStarted));")
          DRIVERS_COUNT=$(node -e "const data = require('./public/data/standings2026.json'); console.log(Array.isArray(data.drivers) ? data.drivers.length : 0);")
          CONSTRUCTORS_COUNT=$(node -e "const data = require('./public/data/standings2026.json'); console.log(Array.isArray(data.constructors) ? data.constructors.length : 0);")

          echo ""
          echo "üèÜ Championship standings:"
          echo "Season started: $SEASON_STARTED"
          echo "Drivers rows: $DRIVERS_COUNT"
          echo "Constructors rows: $CONSTRUCTORS_COUNT"
          echo "Standings updated: $STANDINGS_UPDATED"
        else
          echo "‚ùå No public/data/standings2026.json file found"
        fi
