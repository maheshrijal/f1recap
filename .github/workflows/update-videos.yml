name: Update F1 Videos

on:
  schedule:
    # Run every 30 minutes during GP weekends â€” full UTC coverage for Fri/Sat/Sun to avoid delays on APAC rounds
    - cron: '*/30 * * * 5'   # Friday (all day UTC)
    - cron: '*/30 * * * 6'   # Saturday
    - cron: '*/30 * * * 0'   # Sunday
    # Monday morning sweep for late uploads and corrections (00:00â€“12:00 UTC)
    - cron: '*/30 0-12 * * 1'
  workflow_dispatch: # Allow manual trigger
    inputs:
      reason:
        description: 'Reason for manual update'
        required: false
        default: 'Manual update requested'
        type: string
      force_update:
        description: 'Force update even if no new videos found'
        required: false
        default: false
        type: boolean
  push:
    branches: [ main ]

jobs:
  update-videos:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow writing to repository
      actions: read    # Allow reading workflow info
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Decide if update is needed
      id: gate
      env:
        MANUAL_RUN: ${{ github.event_name == 'workflow_dispatch' }}
        FORCE_RUN: ${{ github.event.inputs.force_update || 'false' }}
      run: node scripts/should-run.js
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
      if: steps.gate.outputs.run == 'true'
        
    - name: Install dependencies
      run: npm ci
      if: steps.gate.outputs.run == 'true'
      
    - name: Fetch latest videos
      env:
        YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        MANUAL_RUN: ${{ github.event_name == 'workflow_dispatch' }}
        UPDATE_REASON: ${{ github.event.inputs.reason || 'Scheduled update' }}
      run: |
        echo "ğŸš€ Starting F1 video fetch..."
        echo "Reason: $UPDATE_REASON"
        npm run fetch
      if: steps.gate.outputs.run == 'true'
      
    - name: Commit and push changes
      run: |
        # Configure git with GitHub Actions bot
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Add the videos.json file
        git add videos.json
        
        # Check if there are changes or if force update is enabled
        if git diff --staged --quiet && [ "${{ github.event.inputs.force_update }}" != "true" ]; then
          echo "âœ… No changes to commit"
        else
          # Create appropriate commit message
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            COMMIT_MSG="ğŸï¸ Manual F1 video update - ${{ github.event.inputs.reason || 'Manual update' }} ($(date))"
          else
            COMMIT_MSG="ğŸ”„ Auto F1 video update - $(date)"
          fi
          
          echo "ğŸ“ Committing with message: $COMMIT_MSG"
          git commit -m "$COMMIT_MSG"
          
          echo "ğŸš€ Pushing changes..."
          git push origin HEAD:${{ github.ref_name }}
          echo "âœ… Changes committed and pushed successfully"
        fi
      if: steps.gate.outputs.run == 'true'
      
    - name: Summary
      run: |
        echo "ğŸ“Š F1 Video Update Summary"
        echo "=========================="
        
        echo "Gate run? ${{ steps.gate.outputs.run || 'false' }} (reason: ${{ steps.gate.outputs.reason || 'n/a' }})"
        
        if [ -f videos.json ]; then
          TOTAL_VIDEOS=$(node -e "const data = require('./videos.json'); console.log(data.totalVideos || 0);")
          WEEKENDS=$(node -e "const data = require('./videos.json'); console.log((data.grandPrixWeekends || []).length);")
          LAST_UPDATED=$(node -e "const data = require('./videos.json'); console.log(data.lastUpdated || 'Unknown');")
          
          echo "ğŸ“¹ Total videos: $TOTAL_VIDEOS"
          echo "ğŸ Grand Prix weekends: $WEEKENDS"
          echo "ğŸ•’ Last updated: $LAST_UPDATED"
          
          if [ "$WEEKENDS" -gt 0 ]; then
            echo ""
            echo "ğŸï¸ Current weekends:"
            node -e "
              const data = require('./videos.json');
              (data.grandPrixWeekends || []).forEach((gp, i) => {
                const status = i === 0 ? 'ğŸ”´ Current' : i === 1 ? 'ğŸŸ¡ Recent' : 'âšª Past';
                console.log(\`  \${status} \${gp.name} (\${gp.videos.length} videos)\`);
              });
            "
          fi
        else
          echo "âŒ No videos.json file found"
        fi
